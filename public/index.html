<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Razorpay Demo Checkout</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
      body { padding: 2rem; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="mb-4">Razorpay Demo Checkout</h1>
      <div class="card p-3">
        <label class="form-label">Amount (₹)</label>
        <input id="amount" class="form-control mb-3" type="number" value="499" />
        <button id="pay" class="btn btn-primary">Pay Now</button>
        <div id="result" class="mt-3"></div>
      </div>
    </div>

    <script>
      async function createOrder(amountInRupees) {
        const amountPaise = Math.round(Number(amountInRupees) * 100);
        const res = await fetch('/api/payments/create-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount: amountPaise })
        });
        if (!res.ok) throw new Error('Failed to create order');
        const data = await res.json();
        return data.order;
      }

      async function verifyPayment(details) {
        const res = await fetch('/api/payments/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(details)
        });
        const data = await res.json();
        return data.ok;
      }

      document.getElementById('pay').addEventListener('click', async () => {
        const amount = document.getElementById('amount').value || 0;
        const result = document.getElementById('result');
        result.textContent = '';

        try {
          const cfgRes = await fetch('/api/config/public-key');
          const cfg = await cfgRes.json();
          const order = await createOrder(amount);
          const options = {
            key: cfg.keyId || '',
            amount: order.amount,
            currency: order.currency,
            name: 'FoodApp',
            description: 'Order Payment',
            order_id: order.id,
            handler: async function (response) {
              const ok = await verifyPayment(response);
              result.textContent = ok ? 'Payment verified ✅' : 'Payment verification failed ❌';
            },
            prefill: {
              name: 'Test User',
              email: 'test@example.com',
              contact: '9999999999'
            },
            theme: { color: '#3399cc' }
          };

          const rzp = new Razorpay(options);
          rzp.open();
        } catch (e) {
          result.textContent = e.message || 'Error';
        }
      });
    </script>
  </body>
</html>
